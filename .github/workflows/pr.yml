name: 🤖 Akıllı M3U8 Güncelleyici

on:
  schedule:
    - cron: "0 */6 * * *"  # Her 6 saatte bir
  workflow_dispatch:

jobs:
  check-and-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🛎️ Repoyu Çek
      uses: actions/checkout@v4

    - name: 🐍 Python Kur
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: 📦 Bağımlılıkları Kur
      run: pip install cloudscraper requests Kekik

    - name: 🔄 Güncellemeleri Kontrol Et ve PR Aç
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Scripti çalıştır ve değişiklik kontrolü yap
        python m3u8_updater.py
        DEGISIKLIK=$(python -c "import json; print(json.load(open('$GITHUB_OUTPUT'))['degisiklik'])")

        if [ "$DEGISIKLIK" = "true" ]; then
          # Yeni branch oluştur
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git checkout -b "m3u8-guncelleme-$(date +'%Y%m%d-%H%M%S')"
          
          # Değişiklikleri kaydet
          git add channels.m3u
          git commit -m "🤖 Otomatik Güncelleme: $(date +'%d.%m.%Y %H:%M')"
          
          # PR oluştur
          git push origin HEAD
          gh pr create --base main --head "$(git branch --show-current)" \
            --title "🤖 M3U8 Güncellemesi" \
            --body "Otomatik olarak oluşturuldu"
        else
          echo "Değişiklik yok, işlem yapılmadı"
        fi
